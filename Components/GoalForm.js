import React from "react";
import {
  View,
  Text,
  TextInput,
  TouchableOpacity,
  TouchableWithoutFeedback,
  Keyboard,
} from "react-native";
import DateTimePicker from "@react-native-community/datetimepicker";
import { Feather } from "@expo/vector-icons";
import DeleteConfirmModal from "./DeleteConfirmModal";

const GoalForm = ({
  styles,
  customDaysModalVisible,
  setCustomDaysModalVisible,
  customDaysInput,
  setCustomDaysInput,
  handleDurationSelect,
  editingGoal,
  setShowGoalForm,
  resetGoalForm,
  setEditingGoal,
  setEditingIndex,
  title,
  setTitle,
  color,
  setColor,
  startDate,
  endDate,
  setPickerMode,
  setShowPicker,
  showPicker,
  pickerMode,
  onChange,
  isStartDateTouched,
  setIsStartDateTouched,
  subGoals,
  setSubGoals,
  newSubGoalText,
  setNewSubGoalText,
  subGoalModalVisible,
  setSubGoalModalVisible,
  showDeleteModal,
  setShowDeleteModal,
  onDeleteGoal,
  saveAsTemplate,
  onUpdateGoal,
  onAddGoal,
  isTemplate,
  saveTemplate,
  formatDate,
  editingIndex,
}) => {
  return (
    <TouchableWithoutFeedback onPress={() => Keyboard.dismiss()}>
      <View style={styles.goalForm}>
       {customDaysModalVisible && (
              <View style={styles.customDaysModal}>
                <Text style={{ marginBottom: 10 }}>
                  Î©∞Ïπ† ÌõÑÍπåÏßÄ ÏÑ§Ï†ïÌï†ÍπåÏöî?
                </Text>
                <TextInput
                  value={customDaysInput}
                  onChangeText={setCustomDaysInput}
                  keyboardType="numeric"
                  placeholder="Ïà´ÏûêÎßå ÏûÖÎ†•"
                  style={styles.modalInput}
                />
                <View style={styles.modalButtonContainer}>
                  <TouchableOpacity
                    onPress={() => setCustomDaysModalVisible(false)}
                    style={{ marginRight: 10 }}
                  >
                    <Text>Ï∑®ÏÜå</Text>
                  </TouchableOpacity>
                  <TouchableOpacity
                    onPress={() => {
                      const days = parseInt(customDaysInput, 10);
                      if (!isNaN(days)) {
                        handleDurationSelect(days);
                        setCustomDaysInput("");
                        setCustomDaysModalVisible(false);
                      } else {
                        alert("Ïò¨Î∞îÎ•∏ Ïà´ÏûêÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
                      }
                    }}
                    style={styles.modalButton}
                  >
                    <Text>ÌôïÏù∏</Text>
                  </TouchableOpacity>
                </View>
              </View>
            )}
            <View style={styles.goalFormHeader}>
              <Text style={styles.goalFormTitle}>
                {" "}
                {editingGoal ? "Î™©Ìëú ÏàòÏ†ï" : "ÏÉàÎ°úÏö¥ Î™©Ìëú"}
              </Text>
              <TouchableOpacity
                onPress={() => {
                  if (editingGoal) {
                    // ÏàòÏ†ï Ï§ëÏù¥Î©¥ ÌèºÎßå Îã´Í∏∞
                    setShowGoalForm(false);
                    setEditingGoal(null);
                    setEditingIndex(null);
                  } else {
                    // ÏÉà Î™©Ìëú ÏÉùÏÑ± Ï§ëÏù¥Î©¥ ÏôÑÏ†Ñ Ï¥àÍ∏∞Ìôî
                    resetGoalForm();
                  }
                }}
              >
                <Text style={{ fontSize: 18 }}>‚úï</Text>
              </TouchableOpacity>
            </View>

            <View
              style={{
                flexDirection: "row",
                alignItems: "center",
                marginBottom: 10,
              }}
            >
              <TextInput
                style={[styles.input, { flex: 1 }]}
                placeholder="Î™©ÌëúÎ™Ö"
                value={title}
                onChangeText={setTitle}
              />
              <View style={{ flexDirection: "row", marginLeft: 10 }}>
                {["red", "yellow", "green"].map((c) => (
                  <TouchableOpacity
                    key={c}
                    onPress={() => setColor(c)}
                    style={{
                      width: 24,
                      height: 24,
                      borderRadius: 12,
                      backgroundColor:
                        c === "red"
                          ? "#EF4444"
                          : c === "yellow"
                          ? "#FACC15"
                          : "#22C55E",
                      marginHorizontal: 4,
                      borderWidth: color === c ? 2 : 0,
                      borderColor: "black",
                    }}
                  />
                ))}
              </View>
            </View>

            {/* ÎÇ†Ïßú ÏÑ†ÌÉù Ïª¥Ìè¨ÎÑåÌä∏ */}
            <View
              style={[styles.row, { alignItems: "center", flexWrap: "nowrap" }]}
            >
              <Feather
                name="calendar"
                size={20}
                color="#444"
                style={{ marginRight: 8 }}
              />

              <TouchableOpacity
                style={{
                  borderWidth: 1,
                  borderColor: "#ccc",
                  borderRadius: 6,
                  paddingVertical: 6,
                  paddingHorizontal: 10,
                  marginRight: 6,
                  width: 120,
                  justifyContent: "center",
                  alignItems: "center",
                }}
                onPress={() => {
                  setIsStartDateTouched(true); // üëâ ÏÇ¨Ïö©ÏûêÍ∞Ä ÏßÅÏ†ë ÏÑ†ÌÉùÌï®
                  setPickerMode("start");
                  setShowPicker(true);
                }}
              >
                <Text style={{ fontSize: 14, color: "#444" }}>
                  {formatDate(startDate)}
                </Text>
              </TouchableOpacity>

              <Text style={{ marginHorizontal: 4 }}>‚Üí</Text>

              <TouchableOpacity
                style={{
                  borderWidth: 1,
                  borderColor: "#ccc",
                  borderRadius: 6,
                  paddingVertical: 6,
                  paddingHorizontal: 10,
                  width: 120,
                  justifyContent: "center",
                  alignItems: "center",
                }}
                onPress={() => {
                  setPickerMode("end");
                  setShowPicker(true);
                }}
              >
                <Text style={{ fontSize: 14, color: "#444" }}>
                  {formatDate(endDate)}
                </Text>
              </TouchableOpacity>
            </View>

            {/* DateTimePicker Î™®Îã¨ */}
            {showPicker && (
              <DateTimePicker
                value={pickerMode === "start" ? startDate : endDate}
                mode="date"
                display="default"
                onChange={onChange}
                minimumDate={pickerMode === "end" ? startDate : undefined}
              />
            )}

            {/* Í∏∞Ï°¥ UI Í≥ÑÏÜç Ïú†ÏßÄ */}
            <View style={styles.row}>
              <TouchableOpacity
                style={styles.smallButton}
                onPress={() => handleDurationSelect(3)}
              >
                <Text>3</Text>
              </TouchableOpacity>
              <TouchableOpacity
                style={styles.smallButton}
                onPress={() => handleDurationSelect(7)}
              >
                <Text>7</Text>
              </TouchableOpacity>
              <TouchableOpacity
                style={styles.smallButton}
                onPress={() => handleDurationSelect(30)}
              >
                <Text>30</Text>
              </TouchableOpacity>
              <TouchableOpacity
                style={styles.smallButton}
                onPress={() => setCustomDaysModalVisible(true)}
              >
                <Text>Ôºã</Text>
              </TouchableOpacity>
            </View>

            <View style={styles.row}>
              <Feather
                name="repeat"
                size={20}
                color="#888"
                style={{ marginRight: 6, alignSelf: "center" }}
              />
              <TouchableOpacity style={styles.smallButton}>
                <Text>Îß§Ïùº</Text>
              </TouchableOpacity>
              <TouchableOpacity style={styles.smallButton}>
                <Text>ÏùºÏ£ºÏùº</Text>
              </TouchableOpacity>
              <TouchableOpacity style={styles.smallButton}>
                <Text>ÌïúÎã¨</Text>
              </TouchableOpacity>
              <TouchableOpacity style={styles.smallButton}>
                <Text>Ôºã</Text>
              </TouchableOpacity>
            </View>

            <View style={styles.row}>
              <TouchableOpacity style={styles.smallButton}>
                <Text>5</Text>
              </TouchableOpacity>
              <TouchableOpacity
                style={[styles.smallButton, { backgroundColor: "#ccc" }]}
              >
                <Text>10</Text>
              </TouchableOpacity>
              <TouchableOpacity style={styles.smallButton}>
                <Text>30</Text>
              </TouchableOpacity>
              <TouchableOpacity style={styles.smallButton}>
                <Text>1h</Text>
              </TouchableOpacity>
              <TouchableOpacity style={styles.smallButton}>
                <Text>...</Text>
              </TouchableOpacity>
            </View>

            <View style={[styles.row, { alignItems: "center", marginTop: 12 }]}>
              <Feather
                name="scissors"
                size={16}
                color="#444"
                style={{ marginRight: 8 }}
              />

              <View style={{ flexDirection: "row", alignItems: "center" }}>
                <View
                  style={{
                    flexDirection: "row",
                    alignItems: "center",
                    marginRight: 10,
                  }}
                >
                  <View
                    style={{
                      width: 16,
                      height: 16,
                      borderRadius: 8,
                      borderWidth: 2,
                      borderColor: "#444",
                      justifyContent: "center",
                      alignItems: "center",
                      marginRight: 6,
                    }}
                  >
                    <View
                      style={{
                        width: 8,
                        height: 8,
                        borderRadius: 4,
                        backgroundColor: "#444",
                      }}
                    />
                  </View>
                  <Text>Ï†ïÎüâ ÏûÖÎ†•</Text>
                </View>

                <TextInput
                  style={{
                    borderWidth: 1,
                    borderColor: "#444",
                    borderRadius: 6,
                    paddingVertical: 6,
                    paddingHorizontal: 10,
                    backgroundColor: "#fff",
                    width: 100,
                  }}
                  placeholder="Ïà´ÏûêÎßå ÏûÖÎ†•"
                  keyboardType="numeric"
                />
              </View>
            </View>

            <Text style={{ marginTop: 12, fontWeight: "bold" }}>ÏÑ∏Î∂Ä Î™©Ìëú</Text>
            <View style={styles.subGoalList}>
              {subGoals.map((sg, idx) => {
                const text = typeof sg === "string" ? sg : sg?.text ?? ""; // Í∞ùÏ≤¥Ïùº ÎïåÎèÑ ÏïàÏ†ÑÌïòÍ≤å Ï≤òÎ¶¨
                return (
                  <View key={idx} style={styles.subGoalItem}>
                    <Text>‚úÖ {text}</Text>
                    <TouchableOpacity
                      onPress={() => {
                        const updated = [...subGoals];
                        updated.splice(idx, 1);
                        setSubGoals(updated);
                      }}
                    >
                      <Text>‚úï</Text>
                    </TouchableOpacity>
                  </View>
                );
              })}

              <TouchableOpacity
                style={[
                  styles.smallButton,
                  { alignSelf: "flex-start", marginTop: 10 },
                ]}
                onPress={() => setSubGoalModalVisible(true)}
              >
                <Text>Ôºã</Text>
              </TouchableOpacity>
            </View>

            {subGoalModalVisible && (
              <View
                style={{
                  position: "absolute",
                  top: "35%",
                  left: "10%",
                  width: "80%",
                  padding: 20,
                  backgroundColor: "white",
                  borderRadius: 10,
                  elevation: 10,
                  shadowColor: "#000",
                  shadowOffset: { width: 0, height: 2 },
                  shadowOpacity: 0.3,
                  shadowRadius: 4,
                }}
              >
                <Text style={{ marginBottom: 10 }}>ÏÑ∏Î∂Ä Î™©ÌëúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî</Text>
                <TextInput
                  value={newSubGoalText}
                  onChangeText={setNewSubGoalText}
                  placeholder="Ïòà: API Î™ÖÏÑ∏ÏÑú ÏûëÏÑ±"
                  style={{
                    borderWidth: 1,
                    borderColor: "#ccc",
                    borderRadius: 6,
                    padding: 10,
                    marginBottom: 12,
                  }}
                />
                <View
                  style={{ flexDirection: "row", justifyContent: "flex-end" }}
                >
                  <TouchableOpacity
                    onPress={() => setSubGoalModalVisible(false)}
                    style={{ marginRight: 10 }}
                  >
                    <Text>Ï∑®ÏÜå</Text>
                  </TouchableOpacity>
                  <TouchableOpacity
                    onPress={() => {
                      if (newSubGoalText.trim()) {
                        // setSubGoals([...subGoals, newSubGoalText.trim()]);
                        setSubGoals([
                          ...subGoals,
                          { text: newSubGoalText.trim(), done: false },
                        ]);
                        setNewSubGoalText("");
                        setSubGoalModalVisible(false);
                      } else {
                        alert("ÏÑ∏Î∂Ä Î™©ÌëúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                      }
                    }}
                  >
                    <Text>ÌôïÏù∏</Text>
                  </TouchableOpacity>
                </View>
              </View>
            )}

            <View
              style={{
                flexDirection: "row",
                justifyContent: "space-between",
                marginTop: 14,
              }}
            >
              <TouchableOpacity
                style={{
                  backgroundColor: "#e11d48",
                  width: 48,
                  height: 48,
                  borderRadius: 6,
                  justifyContent: "center",
                  alignItems: "center",
                }}
                onPress={() => {
                  if (editingGoal && editingIndex !== null) {
                    setShowDeleteModal(true); // ÏÇ≠Ï†ú Î™®Îã¨ ÎùÑÏö∞Í∏∞
                  } else {
                    resetGoalForm(); // ÏïÑÎãàÎ©¥ Í∑∏ÎÉ• Ìèº Îã´Í∏∞ Î∞è Ï¥àÍ∏∞Ìôî
                    setIsStartDateTouched(false);
                  }
                }}
              >
                <Feather name="trash-2" size={20} color="white" />
              </TouchableOpacity>
              <DeleteConfirmModal
                visible={showDeleteModal}
                onDelete={() => {
                  if (editingIndex !== null) {
                    onDeleteGoal(editingIndex); // Ïã§Ï†ú ÏÇ≠Ï†ú Ïã§Ìñâ
                  } else {
                    alert("ÏÇ≠Ï†úÌï† Î™©ÌëúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
                  }
                  resetGoalForm();
                  setShowDeleteModal(false); // Î™®Îã¨ Îã´Í∏∞
                }}
                onSaveTemp={() => {
                  // ÌïÑÏöîÌïú Í≤ΩÏö∞ ÌÖúÌîåÎ¶ø Ï†ÄÏû• Î°úÏßÅ
                  saveAsTemplate(editingGoal);
                  resetGoalForm();
                  setShowDeleteModal(false);
                }}
                onCancel={() => setShowDeleteModal(false)}
              />
              <View style={{ flexDirection: "row" }}>
                {/* ÌÖúÌîåÎ¶øÏúºÎ°ú Ï†ÄÏû• Î≤ÑÌäº */}
                <TouchableOpacity
                  style={{
                    backgroundColor: "white",
                    borderWidth: 1,
                    borderColor: "black",
                    width: 120,
                    height: 48,
                    borderRadius: 6,
                    justifyContent: "center",
                    alignItems: "center",
                    marginRight: 3,
                  }}
                  onPress={() => {
                    saveAsTemplate({
                      title,
                      subGoals,
                      startDate,
                      endDate,
                    });
                    resetGoalForm();
                  }}
                >
                  <Text style={{ color: "black", fontWeight: "bold" }}>
                    ÌÖúÌîåÎ¶øÏúºÎ°ú Ï†ÄÏû•
                  </Text>
                </TouchableOpacity>

                <TouchableOpacity
                  style={{
                    backgroundColor: "black",
                    width: 64,
                    height: 48,
                    borderRadius: 6,
                    justifyContent: "center",
                    alignItems: "center",
                  }}
                  onPress={() => {
                    const goal = {
                      title,
                      subGoals, // ‚úÖ Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏùå OK!
                      startDate: formatDate(startDate),
                      endDate: formatDate(endDate),
                      color,
                      isTemplate,
                      completed: false,
                      progress: 0,
                    };

                    if (editingGoal) {
                      if (editingGoal.isTemplate) {
                        // ÌÖúÌîåÎ¶øÏùÑ ÏàòÏ†ï Ï§ëÏù¥ÎùºÎ©¥ ‚Üí Î™©ÌëúÎ°ú Ï†ÄÏû•
                        onAddGoal(goal);
                      } else {
                        // ‚úÖ Ìï≠ÏÉÅ onUpdateGoal ÏÇ¨Ïö©
                        onUpdateGoal(goal);
                      }
                    } else {
                      if (isTemplate) {
                        saveTemplate(goal);
                      } else {
                        onAddGoal(goal);
                      }
                    }

                    resetGoalForm(); // Ìèº Ï¥àÍ∏∞Ìôî
                  }}
                >
                  <Feather name="check" size={24} color="white" />
                </TouchableOpacity>
              </View>
            </View>
      </View>
    </TouchableWithoutFeedback>
  );
};

export default GoalForm;
